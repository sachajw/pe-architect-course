# FluxCD Installation and Configuration Guide

## Purpose

This guide documents the FluxCD GitOps installation on the `5min-idp` kind cluster. FluxCD provides continuous delivery and automated reconciliation of Kubernetes resources from Git repositories, enabling a declarative GitOps workflow for workshop exercises.

## Overview

**Cluster:** kind cluster named `5min-idp`  
**Flux Version:** v2.7.5  
**Repository:** git@github.com:sachajw/pe-architect-course.git  
**Branch:** main  
**Flux Path:** `workshop/fluxcd/cluster/kind-5min-idp`  

## Architecture

### Components Installed

Flux consists of four core controllers deployed in the `flux-system` namespace:

1. **source-controller** - Manages GitRepository, OCIRepository, HelmRepository, and Bucket sources
2. **kustomize-controller** - Applies Kustomization resources from sources
3. **helm-controller** - Manages HelmRelease resources
4. **notification-controller** - Handles Alerts, Providers, and webhook Receivers

### How It Works

```
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???  Local Development                                          ???
???  /workspaces/pe-coder-aidp/                                 ???
???    ????????? workshop/                                            ???
???        ????????? exercise-*/  (manifests)                         ???
???        ????????? fluxcd/cluster/kind-5min-idp/                    ???
???            ????????? flux-system/  (Flux self-management)         ???
???            ????????? workshop-exercise-*.yaml (Kustomizations)    ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    ???
                    ??? git push
                    ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???  GitHub Repository                                          ???
???  git@github.com:sachajw/pe-architect-course.git            ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                    ???
                    ??? git pull (every 1m)
                    ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???  Flux Controllers in Kubernetes Cluster                     ???
???  - source-controller pulls from GitHub                      ???
???  - kustomize-controller applies manifests                   ???
???  - Changes automatically deployed to cluster                ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
```

## Installation

### Prerequisites

??? Kubernetes cluster running (kind v1.32.0)  
??? Flux CLI installed (v2.7.5)  
??? Git repository with SSH access  
??? SSH key configured (~/.ssh/github-pangarabbit)  

### Bootstrap Command

```bash
flux bootstrap git \
  --url=ssh://git@github.com/sachajw/pe-architect-course.git \
  --branch=main \
  --path=workshop/fluxcd/cluster/kind-5min-idp \
  --private-key-file=/root/.ssh/github-pangarabbit
```

**What this does:**
1. Creates `flux-system` namespace in the cluster
2. Deploys all four Flux controllers
3. Generates a deploy key for GitHub repository access
4. Creates a GitRepository resource pointing to your repo
5. Commits Flux manifests to `workshop/fluxcd/cluster/kind-5min-idp/flux-system/`
6. Creates a Kustomization that watches that path
7. Flux begins self-managing and reconciling changes

### Deploy Key Configuration

After bootstrap, add the generated SSH public key to GitHub:

**Key generated during bootstrap:**
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILOzkF+RjTc8bqEBO8fa3lUYGenHTk5Q7MeZTALq41Wn
```

**Steps:**
1. Go to https://github.com/sachajw/pe-architect-course/settings/keys/new
2. Title: `flux-kind-5min-idp`
3. Paste the key above
4. **Do NOT** enable write access (read-only is sufficient)
5. Click "Add key"

## Repository Structure

```
/workspaces/pe-coder-aidp/
????????? workshop/
???   ????????? fluxcd/
???   ???   ????????? cluster/
???   ???       ????????? kind-5min-idp/
???   ???           ????????? flux-system/              # Auto-generated by bootstrap
???   ???           ???   ????????? gotk-components.yaml  # All Flux controllers (10k+ lines)
???   ???           ???   ????????? gotk-sync.yaml        # GitRepository & root Kustomization
???   ???           ???   ????????? kustomization.yaml    # Kustomize config
???   ???           ????????? workshop-exercise-*.yaml  # Exercise Kustomizations (you create)
???   ????????? foundation/         # Workshop exercise manifests
???   ????????? teams-management/   # Workshop exercise manifests
???   ????????? capoc/              # Workshop exercise manifests
???   ????????? secops/             # Workshop exercise manifests
???   ????????? capstone/           # Workshop exercise manifests
????????? documentation/          # This file
```

## Verification

### Check Flux Status

```bash
# Overall health check
flux check

# View all controllers
kubectl -n flux-system get pods

# Check GitRepository sync status
flux get sources git

# Check Kustomizations
flux get kustomizations
```

### Expected Output

```
$ flux check
??? Kubernetes 1.32.0 >=1.32.0-0
??? distribution: flux-v2.7.5
??? bootstrapped: true
??? helm-controller: deployment ready
??? kustomize-controller: deployment ready
??? notification-controller: deployment ready
??? source-controller: deployment ready
??? all checks passed
```

```
$ kubectl -n flux-system get pods
NAME                                       READY   STATUS    RESTARTS   AGE
helm-controller-744dd856d8-c2rlr           1/1     Running   0          5m
kustomize-controller-5b4ffc8554-946d7      1/1     Running   0          5m
notification-controller-78b57db948-plm86   1/1     Running   0          5m
source-controller-5d44b8b787-299jw         1/1     Running   0          5m
```

```
$ flux get sources git
NAME        REVISION           SUSPENDED  READY  MESSAGE
flux-system main@sha1:a43246d1 False      True   stored artifact for revision 'main@sha1:a43246d1'
```

## Usage: Adding Workshop Exercises

### Creating a Kustomization for an Exercise

To have Flux monitor and deploy a workshop exercise, create a Kustomization resource:

**Method 1: Using Flux CLI (Recommended)**

```bash
# Generate Kustomization manifest
flux create kustomization workshop-foundation \
  --source=GitRepository/flux-system \
  --path="./workshop/foundation" \
  --prune=true \
  --interval=1m \
  --export > /workspaces/pe-coder-aidp/workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml

# Commit and push
cd /workspaces/pe-coder-aidp
git add workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml
git commit -m "Add foundation exercise to Flux"
git push

# Flux will automatically detect and apply within 1 minute
```

**Method 2: Manual YAML Creation**

Create `/workspaces/pe-coder-aidp/workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml`:

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: workshop-foundation
  namespace: flux-system
spec:
  interval: 1m0s
  path: ./workshop/foundation
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  timeout: 2m0s
```

Then commit and push.

### Kustomization Options Explained

- **interval**: How often Flux checks for changes (default: 1m)
- **path**: Directory containing Kubernetes manifests (relative to repo root)
- **prune**: If true, removes resources deleted from Git (use carefully)
- **sourceRef**: Points to the GitRepository to pull from
- **timeout**: Maximum time to wait for reconciliation
- **dependsOn**: (optional) Wait for other Kustomizations first
- **targetNamespace**: (optional) Deploy all resources to specific namespace

### Example: Foundation Exercise

```bash
# Create Kustomization
flux create kustomization workshop-foundation \
  --source=GitRepository/flux-system \
  --path="./workshop/foundation" \
  --prune=true \
  --interval=1m \
  --export > workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml

# Commit and push
git add workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml
git commit -m "Add foundation exercise"
git push

# Watch reconciliation
flux get kustomizations -w
```

### Example: Teams Management (with Dependency)

```bash
# Teams might depend on foundation being ready first
flux create kustomization workshop-teams \
  --source=GitRepository/flux-system \
  --path="./workshop/teams-management" \
  --prune=true \
  --interval=1m \
  --depends-on=workshop-foundation \
  --export > workshop/fluxcd/cluster/kind-5min-idp/workshop-teams.yaml
```

## GitOps Workflow

### Day-to-Day Operations

1. **Make changes locally:**
   ```bash
   cd /workspaces/pe-coder-aidp/workshop/foundation
   # Edit Kubernetes manifests
   vim deployment.yaml
   ```

2. **Commit and push:**
   ```bash
   git add .
   git commit -m "Update foundation deployment"
   git push
   ```

3. **Flux automatically reconciles** (within 1 minute by default)

4. **Monitor reconciliation:**
   ```bash
   flux get kustomizations
   flux logs --level=info
   ```

### Force Immediate Reconciliation

```bash
# Reconcile specific Kustomization immediately
flux reconcile kustomization workshop-foundation

# Reconcile the GitRepository source
flux reconcile source git flux-system
```

## Troubleshooting

### Check Kustomization Status

```bash
flux get kustomizations
kubectl describe kustomization workshop-foundation -n flux-system
```

### View Flux Logs

```bash
# All controllers
flux logs --all-namespaces

# Specific controller
flux logs --kind=Kustomization --name=workshop-foundation
kubectl logs -n flux-system deploy/kustomize-controller
```

### Common Issues

**Issue: GitRepository not reconciling**
```bash
# Check source status
flux get sources git
kubectl describe gitrepository flux-system -n flux-system

# Verify deploy key is added to GitHub
# Check SSH key has read access to repository
```

**Issue: Kustomization fails with validation errors**
```bash
# Check for YAML syntax errors locally
kubectl apply --dry-run=client -f workshop/foundation/

# Check Kustomization events
kubectl describe kustomization workshop-foundation -n flux-system
```

**Issue: Resources not appearing in cluster**
```bash
# Verify path is correct
flux get kustomizations

# Check if prune is removing resources accidentally
kubectl get kustomization workshop-foundation -n flux-system -o yaml
```

### Health Monitoring

```bash
# Check all Flux components
flux check

# Monitor reconciliation in real-time
flux get kustomizations -w

# Check resource inventory
kubectl get kustomization workshop-foundation -n flux-system -o jsonpath='{.status.inventory.entries}' | jq
```

## API Reference

### GitRepository CRD

```yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 1m0s
  ref:
    branch: main
  secretRef:
    name: flux-system
  url: ssh://git@github.com/sachajw/pe-architect-course.git
```

### Kustomization CRD

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: workshop-exercise
  namespace: flux-system
spec:
  interval: 1m0s              # Reconciliation interval
  path: ./workshop/exercise   # Path in repository
  prune: true                 # Remove deleted resources
  sourceRef:
    kind: GitRepository
    name: flux-system
  timeout: 2m0s               # Reconciliation timeout
  wait: true                  # Wait for resources to be ready
  retryInterval: 1m0s         # Retry interval on failure
  dependsOn:                  # Wait for dependencies
    - name: other-kustomization
  targetNamespace: default    # Override namespace
  healthChecks:               # Custom health checks
    - kind: Deployment
      name: app
      namespace: default
  postBuild:                  # Variable substitution
    substitute:
      cluster_name: "5min-idp"
    substituteFrom:
      - kind: ConfigMap
        name: vars
```

## Advanced Configuration

### Using ConfigMaps for Variables

```bash
# Create ConfigMap with variables
kubectl create configmap cluster-vars -n flux-system \
  --from-literal=cluster_name=5min-idp \
  --from-literal=environment=workshop

# Reference in Kustomization
flux create kustomization workshop-app \
  --source=GitRepository/flux-system \
  --path="./workshop/app" \
  --prune=true \
  --interval=1m \
  --post-build-substitute-from=configmap/cluster-vars \
  --export > workshop/fluxcd/cluster/kind-5min-idp/workshop-app.yaml
```

### Using Secrets

```bash
# Create secret for sensitive values
kubectl create secret generic app-secrets -n flux-system \
  --from-literal=api_key=secret123

# Reference in manifests with ${api_key} placeholder
# Flux will substitute from the secret
```

### Health Checks

Add custom health checks to Kustomizations:

```yaml
spec:
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: my-app
      namespace: default
    - apiVersion: v1
      kind: Service
      name: my-service
      namespace: default
```

## Migration Guide

### From Manual kubectl apply

**Before (Manual):**
```bash
kubectl apply -f workshop/foundation/
```

**After (GitOps):**
```bash
# One-time: Create Kustomization
flux create kustomization workshop-foundation \
  --source=GitRepository/flux-system \
  --path="./workshop/foundation" \
  --prune=true \
  --interval=1m \
  --export > workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml

git add workshop/fluxcd/cluster/kind-5min-idp/workshop-foundation.yaml
git commit -m "Migrate foundation to GitOps"
git push

# Future changes: Just commit and push
# Flux handles kubectl apply automatically
```

### Cleaning Up Manual Resources

If you've manually applied resources before Flux:

```bash
# Let Flux take ownership
flux reconcile kustomization workshop-foundation

# Flux will add its labels to existing resources
# Future changes must go through Git
```

## Dependencies

- **Kubernetes:** v1.32.0+
- **Flux CLI:** v2.7.5+
- **Git:** SSH access to repository
- **GitHub:** Deploy key configured with read access

## Security Considerations

1. **Deploy Key:** Read-only access is sufficient for Flux to pull changes
2. **Private Key:** Stored as Kubernetes Secret `flux-system/flux-system`
3. **RBAC:** Flux controllers run with cluster-admin permissions (required for full GitOps)
4. **Secrets Management:** Use sealed-secrets or SOPS for encrypting secrets in Git

## Performance Notes

- Default reconciliation interval: 1 minute
- GitRepository clones are cached by source-controller
- Multiple Kustomizations can share the same GitRepository source
- Flux uses server-side apply for improved performance

## Additional Resources

- Flux Documentation: https://fluxcd.io/flux/
- Flux GitHub: https://github.com/fluxcd/flux2
- Kubernetes Documentation: https://kubernetes.io/docs/
- GitOps Principles: https://opengitops.dev/

## Maintenance

### Upgrading Flux

```bash
# Check for updates
flux check --pre

# Upgrade Flux components
flux install --export > workshop/fluxcd/cluster/kind-5min-idp/flux-system/gotk-components.yaml

# Commit and push
git add workshop/fluxcd/cluster/kind-5min-idp/flux-system/gotk-components.yaml
git commit -m "Upgrade Flux to latest version"
git push
```

### Uninstalling Flux

```bash
# Remove Flux components (keeps CRDs)
flux uninstall --keep-namespace

# Complete removal (including CRDs)
flux uninstall --crds
```

---

**Document Version:** 1.0  
**Last Updated:** 2026-02-09  
**Cluster:** kind-5min-idp  
**Flux Version:** v2.7.5
